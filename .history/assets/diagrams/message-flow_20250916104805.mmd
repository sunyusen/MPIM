sequenceDiagram
    participant C1 as 客户端A
    participant GW1 as 网关1
    participant MS as 消息服务
    participant PS as 在线状态服务
    participant Redis as Redis
    participant GW2 as 网关2
    participant C2 as 客户端B
    participant DB as MySQL
    
    Note over C1,DB: 用户A发送消息给用户B
    
    C1->>GW1: SEND 123 "Hello"
    GW1->>MS: SendReq(msg)
    MS->>PS: QueryRoute(userB)
    PS->>Redis: GET route:123
    Redis-->>PS: gateway-002
    PS-->>MS: gateway-002
    
    alt 用户B在线
        MS->>Redis: PUBLISH channel-002 msg
        Redis->>GW2: 消息推送
        GW2->>C2: MSG from=456 text="Hello"
        MS-->>GW1: +OK msg_id=789
        GW1-->>C1: +OK msg_id=789
    else 用户B离线
        MS->>DB: INSERT offline_msg
        MS-->>GW1: +OK msg_id=789
        GW1-->>C1: +OK msg_id=789
    end
