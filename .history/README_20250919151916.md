# MPIM â€” åˆ†å¸ƒå¼å³æ—¶é€šè®¯ç³»ç»Ÿ

[![C++](https://img.shields.io/badge/C++-17-blue.svg)](https://en.cppreference.com/w/cpp/17)
[![CMake](https://img.shields.io/badge/CMake-3.16+-green.svg)](https://cmake.org/)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

ä¸€ä¸ªåŸºäºC++çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼å³æ—¶é€šè®¯ç³»ç»Ÿï¼Œé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œæ”¯æŒç”¨æˆ·ç®¡ç†ã€æ¶ˆæ¯å‘é€ã€ç¾¤ç»„åŠŸèƒ½ã€åœ¨çº¿çŠ¶æ€ç®¡ç†ç­‰æ ¸å¿ƒIMåŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½**: åŸºäºMuduoç½‘ç»œåº“ï¼Œæ”¯æŒé«˜å¹¶å‘è¿æ¥
- ğŸ—ï¸ **å¾®æœåŠ¡æ¶æ„**: 6ä¸ªç‹¬ç«‹æœåŠ¡æ¨¡å—ï¼Œæ¾è€¦åˆè®¾è®¡
- ğŸ”„ **è‡ªç ”RPCæ¡†æ¶**: åŸºäºProtobufçš„é«˜æ•ˆRPCé€šä¿¡
- ğŸ“¡ **æœåŠ¡å‘ç°**: ZooKeeperå®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°
- ğŸ’¾ **å¤šå­˜å‚¨æ”¯æŒ**: Redis(ç¼“å­˜+æ¶ˆæ¯é˜Ÿåˆ—) + MySQL(æŒä¹…åŒ–å­˜å‚¨)
- âš¡ **æ™ºèƒ½ç¼“å­˜**: Redisç¼“å­˜ç”¨æˆ·ä¿¡æ¯ã€å¥½å‹å…³ç³»ã€ç¾¤ç»„æ•°æ®ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- ğŸ¯ **æ™ºèƒ½è·¯ç”±**: åŸºäºç”¨æˆ·åœ¨çº¿çŠ¶æ€çš„æ™ºèƒ½æ¶ˆæ¯è·¯ç”±
- ğŸ“± **å®Œæ•´å®¢æˆ·ç«¯**: äº¤äº’å¼å‘½ä»¤è¡Œå®¢æˆ·ç«¯
- ğŸ› ï¸ **æ˜“äºéƒ¨ç½²**: ä¸€é”®å¯åŠ¨è„šæœ¬ï¼ŒDockeræ”¯æŒ

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    %% ===== å®¢æˆ·ç«¯ / æ¥å…¥å±‚ =====
    subgraph å®¢æˆ·ç«¯å±‚
        CLI[CLIå®¢æˆ·ç«¯]
    end

    subgraph æ¥å…¥å±‚
        GW[Gateway ç½‘å…³]
    end

    %% ===== æœåŠ¡å±‚ =====
    subgraph æœåŠ¡å±‚
        US[User Service\nç”¨æˆ·ç®¡ç†]
        PS[Presence Service\nåœ¨çº¿çŠ¶æ€/è·¯ç”±]
        MS[Message Service\næ¶ˆæ¯/ç¦»çº¿æ¶ˆæ¯]
        GS[Group Service\nç¾¤ç»„ç®¡ç†]
    end

    %% ===== ä¸­é—´ä»¶ä¸åŸºç¡€è®¾æ–½ =====
    subgraph ä¸­é—´ä»¶å±‚
        RPC[è‡ªç ” RPC æ¡†æ¶]
        ZK[ZooKeeper\næœåŠ¡æ³¨å†Œ/å‘ç°]
    end

    subgraph ç¼“å­˜å±‚
        CACHE[Redis ç¼“å­˜\nç”¨æˆ·/å¥½å‹/ç¾¤ç»„/çŠ¶æ€]
    end

    subgraph æ¶ˆæ¯é˜Ÿåˆ—å±‚
        MQ[Redis Pub/Sub\nåœ¨çº¿æ¶ˆæ¯æ¨é€]
    end

    subgraph å­˜å‚¨å±‚
        MySQL[(MySQL\nç”¨æˆ·/æ¶ˆæ¯å†å²/ç¾¤ç»„)]
    end

    %% ===== è¿æ¥å…³ç³» =====
    CLI -->|TCP/è¡Œåè®®| GW
    GW -->|RPC| US
    GW -->|RPC| PS
    GW -->|RPC| MS
    GW -->|RPC| GS

    %% ç¼“å­˜ä½¿ç”¨ï¼ˆCache-Asideï¼Œè¯»å¤šï¼šUser/Group/Presenceï¼‰
    US --> CACHE
    GS --> CACHE
    PS --> CACHE

    %% æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ï¼ˆåœ¨çº¿æ¶ˆæ¯æ¨é€ï¼šPresence/Message â†’ Gateway è®¢é˜…ï¼‰
    PS --> MQ
    MS --> MQ
    MQ --> GW

    %% æ•°æ®è½åœ°ï¼ˆæŒä¹…åŒ–ï¼šUser/Message/Groupï¼‰
    US --> MySQL
    MS --> MySQL
    GS --> MySQL

    %% æœåŠ¡æ³¨å†Œ/å‘ç°ï¼ˆæ‰€æœ‰å¯¹å¤– RPC æœåŠ¡éƒ½æ³¨å†Œï¼‰
    US -.->|æ³¨å†Œ| ZK
    PS -.->|æ³¨å†Œ| ZK
    MS -.->|æ³¨å†Œ| ZK
    GS -.->|æ³¨å†Œ| ZK
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
MPIM/
â”œâ”€â”€ im-gateway/          # ç½‘å…³æœåŠ¡ (805è¡Œ)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ gatewayServer.cc    # ç½‘å…³æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â””â”€â”€ main.cc
â”‚   â””â”€â”€ include/
â”œâ”€â”€ im-user/             # ç”¨æˆ·æœåŠ¡ (468è¡Œ)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ user_service.cc     # ç”¨æˆ·ç®¡ç†é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ user_cache.cc       # Redisç¼“å­˜å®ç°
â”‚   â”‚   â””â”€â”€ main.cc
â”‚   â””â”€â”€ include/
â”‚       â”œâ”€â”€ user_service.h      # ç”¨æˆ·æœåŠ¡æ¥å£
â”‚       â””â”€â”€ user_cache.h        # ç”¨æˆ·ç¼“å­˜æ¥å£
â”œâ”€â”€ im-presence/         # åœ¨çº¿çŠ¶æ€æœåŠ¡ (242è¡Œ)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ presence_service.cc # çŠ¶æ€ç®¡ç†é€»è¾‘
â”‚   â”‚   â””â”€â”€ main.cc
â”‚   â””â”€â”€ include/
â”œâ”€â”€ im-message/          # æ¶ˆæ¯æœåŠ¡ (432è¡Œ)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ message_service.cc  # æ¶ˆæ¯å¤„ç†é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ offline_model.cc    # ç¦»çº¿æ¶ˆæ¯æ¨¡å‹
â”‚   â”‚   â””â”€â”€ main.cc
â”‚   â””â”€â”€ include/
â”œâ”€â”€ im-group/            # ç¾¤ç»„æœåŠ¡ (341è¡Œ)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ group_service.cc    # ç¾¤ç»„ç®¡ç†é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ group_cache.cc      # ç¾¤ç»„ç¼“å­˜å®ç°
â”‚   â”‚   â””â”€â”€ main.cc
â”‚   â””â”€â”€ include/
â”‚       â”œâ”€â”€ group_service.h     # ç¾¤ç»„æœåŠ¡æ¥å£
â”‚       â””â”€â”€ group_cache.h       # ç¾¤ç»„ç¼“å­˜æ¥å£
â”œâ”€â”€ im-client/           # å®¢æˆ·ç«¯ (976è¡Œ)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ client.cc           # å®¢æˆ·ç«¯æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ commandHandler.cc   # å‘½ä»¤å¤„ç†
â”‚   â”‚   â””â”€â”€ main.cc
â”‚   â””â”€â”€ include/
â”œâ”€â”€ mprpc/               # RPCæ¡†æ¶ (1,294è¡Œ)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ rpcprovider.cc      # RPCæä¾›è€…
â”‚   â”‚   â”œâ”€â”€ mprpcchannel.cc     # RPCé€šé“
â”‚   â”‚   â”œâ”€â”€ zookeeperutil.cc    # ZooKeeperå·¥å…·
â”‚   â”‚   â””â”€â”€ logger.cc           # æ—¥å¿—ç³»ç»Ÿ
â”‚   â””â”€â”€ include/
â”œâ”€â”€ im-common/           # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ proto/           # Protobufå®šä¹‰
â”‚   â””â”€â”€ src/             # å…¬å…±å·¥å…·
â”œâ”€â”€ thirdparty/          # ç¬¬ä¸‰æ–¹åº“å°è£… (200+è¡Œ)
â”‚   â”œâ”€â”€ redisclient/     # Rediså®¢æˆ·ç«¯å°è£…
â”‚   â”‚   â”œâ”€â”€ redis_client.h    # åŸºç¡€Redisè¿æ¥
â”‚   â”‚   â”œâ”€â”€ cache_manager.h   # ç¼“å­˜ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ message_queue.h   # æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â””â”€â”€ mysqldb/         # MySQLå®¢æˆ·ç«¯
â”œâ”€â”€ bin/                 # å¯æ‰§è¡Œæ–‡ä»¶å’Œé…ç½®
â”‚   â”œâ”€â”€ *.conf           # æœåŠ¡é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ start.sh         # å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ stop.sh          # åœæ­¢è„šæœ¬
â””â”€â”€ tests/               # å•å…ƒæµ‹è¯•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (CentOS 7+ / Ubuntu 18+)
- **ç¼–è¯‘å™¨**: GCC 11.2.0+ (æ”¯æŒC++17)
- **CMake**: 3.16+
- **ä¾èµ–åº“**:
  - Muduoç½‘ç»œåº“
  - Protobuf 3.11.0+
  - ZooKeeperå®¢æˆ·ç«¯
  - Redis 6.2.6+
  - MySQL 5.7+
  - hiredis 1.0.0+

### å®‰è£…ä¾èµ–

```bash
# CentOS 7
sudo yum install -y gcc-c++ cmake3 protobuf-devel zookeeper-devel

# Ubuntu 18+
sudo apt-get install -y g++ cmake libprotobuf-dev libzookeeper-mt-dev

# å®‰è£…Rediså’ŒMySQL
sudo yum install -y redis mysql-server  # CentOS
sudo apt-get install -y redis-server mysql-server  # Ubuntu
```

### ç¼–è¯‘é¡¹ç›®

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd MPIM

# åˆ›å»ºæ„å»ºç›®å½•
mkdir build && cd build

# é…ç½®å’Œç¼–è¯‘
cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=/usr/bin/gcc -DCMAKE_CXX_COMPILER=/usr/bin/g++
ninja

# æˆ–è€…ä½¿ç”¨make
make -j$(nproc)
```

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨åŸºç¡€è®¾æ–½
sudo systemctl start redis
sudo systemctl start mysql
sudo systemctl start zookeeper

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
cd bin
./start.sh

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./start.sh status
```

### ä½¿ç”¨å®¢æˆ·ç«¯

```bash
# å¯åŠ¨å®¢æˆ·ç«¯
./bin/client

# æ³¨å†Œç”¨æˆ·
register:alice:123456

# ç™»å½•
login:alice:123456

# å‘é€æ¶ˆæ¯
chat:5:Hello World!

# æ‹‰å–ç¦»çº¿æ¶ˆæ¯
pull

# æŸ¥çœ‹å¸®åŠ©
help
```

## ğŸ”§ é…ç½®è¯´æ˜

### æœåŠ¡é…ç½®

æ¯ä¸ªæœåŠ¡éƒ½æœ‰å¯¹åº”çš„é…ç½®æ–‡ä»¶åœ¨`bin/`ç›®å½•ä¸‹ï¼š

- `im-userd.conf` - ç”¨æˆ·æœåŠ¡é…ç½®
- `im-presenced.conf` - åœ¨çº¿çŠ¶æ€æœåŠ¡é…ç½®
- `im-messaged.conf` - æ¶ˆæ¯æœåŠ¡é…ç½®
- `im-groupd.conf` - ç¾¤ç»„æœåŠ¡é…ç½®
- `im-gateway.conf` - ç½‘å…³æœåŠ¡é…ç½®

### æ•°æ®åº“é…ç½®

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE mpim_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- åˆ›å»ºç”¨æˆ·
CREATE USER 'mpim_user'@'localhost' IDENTIFIED BY 'mpim_password';
GRANT ALL PRIVILEGES ON mpim_db.* TO 'mpim_user'@'localhost';
FLUSH PRIVILEGES;
```

### Redisé…ç½®

```bash
# å¯åŠ¨RedisæœåŠ¡
sudo systemctl start redis

# é…ç½®Redis (å¯é€‰)
sudo vim /etc/redis.conf

# ä¸»è¦é…ç½®é¡¹
maxmemory 256mb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000

# é‡å¯Redisä½¿é…ç½®ç”Ÿæ•ˆ
sudo systemctl restart redis
```

### ç¼“å­˜é”®å‘½åè§„èŒƒ

```
# ç”¨æˆ·ç›¸å…³
user:info:{username}          # ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
user:friends:{user_id}        # å¥½å‹å…³ç³»é›†åˆ
user:status:{user_id}         # ç”¨æˆ·åœ¨çº¿çŠ¶æ€
user:exists:{username}        # ç”¨æˆ·åå­˜åœ¨æ€§

# ç¾¤ç»„ç›¸å…³  
group:info:{group_id}         # ç¾¤ç»„åŸºæœ¬ä¿¡æ¯
group:members:{group_id}      # ç¾¤ç»„æˆå‘˜åˆ—è¡¨
user:groups:{user_id}         # ç”¨æˆ·ç¾¤ç»„åˆ—è¡¨

# æ¶ˆæ¯ç›¸å…³
message:queue:{user_id}       # ç”¨æˆ·æ¶ˆæ¯é˜Ÿåˆ—
presence:route:{user_id}      # ç”¨æˆ·è·¯ç”±ä¿¡æ¯
```

## âš¡ Redisç¼“å­˜ç³»ç»Ÿ

### ç¼“å­˜æ¶æ„
- **ç”¨æˆ·ä¿¡æ¯ç¼“å­˜**: ç¼“å­˜ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
- **å¥½å‹å…³ç³»ç¼“å­˜**: ä½¿ç”¨Redis Setå­˜å‚¨å¥½å‹å…³ç³»ï¼Œæ”¯æŒå®æ—¶å¢åˆ 
- **ç¾¤ç»„æ•°æ®ç¼“å­˜**: ç¼“å­˜ç¾¤ç»„ä¿¡æ¯å’Œæˆå‘˜åˆ—è¡¨
- **åœ¨çº¿çŠ¶æ€ç¼“å­˜**: å¿«é€Ÿæ›´æ–°å’ŒæŸ¥è¯¢ç”¨æˆ·åœ¨çº¿çŠ¶æ€
- **æ¶ˆæ¯é˜Ÿåˆ—**: åŸºäºRedis Pub/Subçš„å®æ—¶æ¶ˆæ¯æ¨é€

### ç¼“å­˜ç­–ç•¥
- **Cache-Asideæ¨¡å¼**: å…ˆæŸ¥ç¼“å­˜ï¼Œæœªå‘½ä¸­æ—¶æŸ¥æ•°æ®åº“å¹¶å†™å…¥ç¼“å­˜
- **TTLç®¡ç†**: è‡ªåŠ¨è¿‡æœŸæœºåˆ¶ï¼Œé¿å…ç¼“å­˜æ•°æ®è¿‡æœŸ
- **é™çº§å¤„ç†**: Redisä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢
- **æ•°æ®ä¸€è‡´æ€§**: å†™æ“ä½œæ—¶åŒæ­¥æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“

### æ€§èƒ½æå‡
- **æŸ¥è¯¢æ€§èƒ½**: ç¼“å­˜å‘½ä¸­æ—¶å“åº”æ—¶é—´ < 1ms
- **æ•°æ®åº“å‹åŠ›**: å‡å°‘80%+çš„æ•°æ®åº“æŸ¥è¯¢
- **å¹¶å‘èƒ½åŠ›**: æ”¯æŒé«˜å¹¶å‘ç¼“å­˜è¯»å†™æ“ä½œ
- **å†…å­˜æ•ˆç‡**: æ™ºèƒ½TTLå’ŒLRUæ·˜æ±°ç­–ç•¥

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

- **å¹¶å‘è¿æ¥**: æ”¯æŒ10,000+å¹¶å‘è¿æ¥
- **æ¶ˆæ¯åå**: 10,000+ QPSæ¶ˆæ¯å¤„ç†
- **å»¶è¿Ÿ**: å¹³å‡æ¶ˆæ¯å»¶è¿Ÿ < 10ms (ç¼“å­˜å‘½ä¸­ < 1ms)
- **å¯ç”¨æ€§**: 99.9%æœåŠ¡å¯ç”¨æ€§
- **æ‰©å±•æ€§**: æ°´å¹³æ‰©å±•æ”¯æŒ
- **ç¼“å­˜å‘½ä¸­ç‡**: 90%+ ç”¨æˆ·æŸ¥è¯¢ç¼“å­˜å‘½ä¸­

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°æœåŠ¡

1. åœ¨å¯¹åº”ç›®å½•åˆ›å»ºæœåŠ¡ä»£ç 
2. å®šä¹‰Protobufæ¥å£
3. å®ç°æœåŠ¡é€»è¾‘
4. æ³¨å†Œåˆ°ZooKeeper
5. æ›´æ–°å¯åŠ¨è„šæœ¬

### è‡ªå®šä¹‰RPCæ–¹æ³•

```cpp
// 1. åœ¨.protoæ–‡ä»¶ä¸­å®šä¹‰
service MyService {
    rpc MyMethod(MyRequest) returns (MyResponse);
}

// 2. å®ç°æœåŠ¡ç±»
class MyServiceImpl : public MyService {
public:
    void MyMethod(google::protobuf::RpcController* controller,
                  const MyRequest* request,
                  MyResponse* response,
                  google::protobuf::Closure* done) override {
        // å®ç°é€»è¾‘
    }
};

// 3. æ³¨å†ŒæœåŠ¡
provider.NotifyService(std::make_unique<MyServiceImpl>());
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
cd build
ctest --verbose

# è¿è¡Œæ€§èƒ½æµ‹è¯•
./bin/benchmark

# å‹åŠ›æµ‹è¯•
./bin/stress_test
```

## ğŸ“ˆ ç›‘æ§ä¸æ—¥å¿—

- **æ—¥å¿—ä½ç½®**: `bin/logs/`
- **ç›‘æ§æŒ‡æ ‡**: è¿æ¥æ•°ã€æ¶ˆæ¯é‡ã€å“åº”æ—¶é—´
- **å¥åº·æ£€æŸ¥**: å†…ç½®å¥åº·æ£€æŸ¥æ¥å£

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»ºPull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…

## ğŸ™ è‡´è°¢

- [Muduo](https://github.com/chenshuo/muduo) - é«˜æ€§èƒ½ç½‘ç»œåº“
- [Protobuf](https://github.com/protocolbuffers/protobuf) - æ•°æ®åºåˆ—åŒ–
- [ZooKeeper](https://zookeeper.apache.org/) - åˆ†å¸ƒå¼åè°ƒ
- [Redis](https://redis.io/) - å†…å­˜æ•°æ®åº“
- [MySQL](https://www.mysql.com/) - å…³ç³»æ•°æ®åº“

## ğŸ“ è”ç³»æ–¹å¼

- é¡¹ç›®ç»´æŠ¤è€…: [glf]
- é‚®ç®±: [3103422118@qq.com]
- é¡¹ç›®é“¾æ¥: [https://github.com/sunyusen/MPIM](https://github.com/sunyusen/MPIM)

---

â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™å®ƒä¸€ä¸ªæ˜Ÿæ ‡ï¼