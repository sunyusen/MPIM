# ä¸ºä»€ä¹ˆè¦ç‹¬ç«‹è·¯ç”±æ¨¡å—è€Œä¸æ˜¯ä½¿ç”¨Redisï¼Ÿ

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

åœ¨MPIMç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬è®¾è®¡äº†ç‹¬ç«‹çš„**åœ¨çº¿çŠ¶æ€æœåŠ¡ï¼ˆim-presenceï¼‰**ä½œä¸ºè·¯ç”±æ¨¡å—ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨Redisç­‰å·¥å…·æ¥ç®¡ç†ç”¨æˆ·è·¯ç”±ä¿¡æ¯ã€‚è¿™ä¸ªè®¾è®¡å†³ç­–èƒŒåæœ‰æ·±åˆ»çš„æ¶æ„è€ƒé‡ã€‚

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜åˆ†æ

### å½“å‰æ¶æ„ä¸­çš„è·¯ç”±æ¨¡å—

```mermaid
graph TB
    subgraph "å½“å‰æ¶æ„ - ç‹¬ç«‹è·¯ç”±æœåŠ¡"
        Gateway1[ç½‘å…³1] --> Presence[åœ¨çº¿çŠ¶æ€æœåŠ¡<br/>im-presence]
        Gateway2[ç½‘å…³2] --> Presence
        Gateway3[ç½‘å…³3] --> Presence
        
        Presence --> Redis[(Redisç¼“å­˜)]
        Presence --> MySQL[(MySQLæŒä¹…åŒ–)]
        
        UserService[ç”¨æˆ·æœåŠ¡] -.æŸ¥è¯¢è·¯ç”±.-> Presence
        MsgService[æ¶ˆæ¯æœåŠ¡] -.æŸ¥è¯¢è·¯ç”±.-> Presence
        GroupService[ç¾¤ç»„æœåŠ¡] -.æŸ¥è¯¢è·¯ç”±.-> Presence
    end
    
    style Presence fill:#f9f,stroke:#333,stroke-width:4px
```

### å¦‚æœä½¿ç”¨Redisç›´æ¥ä½œä¸ºè·¯ç”±

```mermaid
graph TB
    subgraph "æ›¿ä»£æ–¹æ¡ˆ - Redisç›´æ¥è·¯ç”±"
        Gateway1[ç½‘å…³1] --> Redis[(Redis<br/>è·¯ç”±ä¿¡æ¯)]
        Gateway2[ç½‘å…³2] --> Redis
        Gateway3[ç½‘å…³3] --> Redis
        
        UserService[ç”¨æˆ·æœåŠ¡] --> Redis
        MsgService[æ¶ˆæ¯æœåŠ¡] --> Redis
        GroupService[ç¾¤ç»„æœåŠ¡] --> Redis
    end
    
    style Redis fill:#faa,stroke:#333,stroke-width:4px
```

---

## ğŸ” ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨Redisï¼Ÿ

### 1. **ä¸šåŠ¡é€»è¾‘å¤æ‚åº¦** â­â­â­â­â­

#### è·¯ç”±æœåŠ¡éœ€è¦å¤„ç†çš„å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼š

```cpp
// âŒ å¦‚æœä½¿ç”¨Redisï¼Œæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦å®ç°è¿™äº›é€»è¾‘
class MessageService {
    void sendMessage(int userId, Message msg) {
        // 1. æŸ¥è¯¢ç”¨æˆ·åœ¨çº¿çŠ¶æ€
        string status = redis.get("user:status:" + userId);
        
        // 2. æŸ¥è¯¢ç”¨æˆ·æ‰€åœ¨ç½‘å…³
        string gateway = redis.get("user:gateway:" + userId);
        
        // 3. æ£€æŸ¥ç½‘å…³æ˜¯å¦å¥åº·
        if (!redis.exists("gateway:heartbeat:" + gateway)) {
            // éœ€è¦å¤„ç†ç½‘å…³æ•…éšœ
            // éœ€è¦æ¸…ç†å¤±æ•ˆè·¯ç”±
            // éœ€è¦é€šçŸ¥ç”¨æˆ·ç¦»çº¿
            // ... å¤æ‚çš„æ•…éšœå¤„ç†é€»è¾‘
        }
        
        // 4. å¤„ç†å¤šç«¯ç™»å½•
        vector<string> gateways = redis.smembers("user:gateways:" + userId);
        for (auto& gw : gateways) {
            // å‘æ¯ä¸ªç½‘å…³å‘é€æ¶ˆæ¯
            // éœ€è¦å¤„ç†éƒ¨åˆ†å¤±è´¥
            // ... å¤æ‚çš„å¤šç«¯åŒæ­¥é€»è¾‘
        }
        
        // 5. å¤„ç†ç¦»çº¿æ¶ˆæ¯
        if (status == "offline") {
            // å­˜å‚¨ç¦»çº¿æ¶ˆæ¯
            // æ¨é€é€šçŸ¥
            // ... ç¦»çº¿é€»è¾‘
        }
        
        // è¿™äº›é€»è¾‘æ•£è½åœ¨å„ä¸ªæœåŠ¡ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤ï¼
    }
};

// âœ… ä½¿ç”¨ç‹¬ç«‹è·¯ç”±æœåŠ¡ï¼Œç»Ÿä¸€å°è£…é€»è¾‘
class PresenceService {
    RouteInfo getRoute(int userId) {
        // æ‰€æœ‰è·¯ç”±ç›¸å…³é€»è¾‘ç»Ÿä¸€åœ¨è¿™é‡Œ
        // å…¶ä»–æœåŠ¡åªéœ€è¦è°ƒç”¨è¿™ä¸ªæ¥å£
        return queryUserRoute(userId);
    }
};
```

#### ä¸šåŠ¡é€»è¾‘åŒ…æ‹¬ï¼š

| ä¸šåŠ¡é€»è¾‘ | Redisæ–¹æ¡ˆ | ç‹¬ç«‹æœåŠ¡æ–¹æ¡ˆ |
|---------|----------|------------|
| **åœ¨çº¿çŠ¶æ€ç®¡ç†** | å„æœåŠ¡è‡ªå·±å®ç° | ç»Ÿä¸€å°è£… âœ… |
| **ç½‘å…³å¥åº·æ£€æŸ¥** | é‡å¤å®ç° | ç»Ÿä¸€ç®¡ç† âœ… |
| **è·¯ç”±å¤±æ•ˆå¤„ç†** | é€»è¾‘åˆ†æ•£ | é›†ä¸­å¤„ç† âœ… |
| **å¤šç«¯ç™»å½•åè°ƒ** | å¤æ‚ä¸”æ˜“é”™ | ä¸€è‡´æ€§ä¿è¯ âœ… |
| **çŠ¶æ€å˜æ›´é€šçŸ¥** | éš¾ä»¥å®ç° | äº‹ä»¶é©±åŠ¨ âœ… |
| **æ•…éšœè‡ªåŠ¨è½¬ç§»** | éœ€æ‰‹åŠ¨ç¼–ç  | è‡ªåŠ¨åŒ–å¤„ç† âœ… |

---

### 2. **æ•°æ®ä¸€è‡´æ€§ä¿éšœ** â­â­â­â­â­

#### ä¸€è‡´æ€§é—®é¢˜åœºæ™¯ï¼š

```cpp
// åœºæ™¯ï¼šç”¨æˆ·åœ¨ç½‘å…³1ç™»å½•ï¼ŒåŒæ—¶åœ¨ç½‘å…³2ä¹Ÿç™»å½•ï¼ˆå¤šç«¯ï¼‰

// âŒ Redisæ–¹æ¡ˆçš„é—®é¢˜
void Gateway1_HandleLogin(int userId) {
    // 1. ç½‘å…³1è®¾ç½®è·¯ç”±
    redis.set("user:gateway:" + userId, "gateway1");
    redis.set("user:status:" + userId, "online");
    
    // 2. å‡ ä¹åŒæ—¶ï¼Œç½‘å…³2ä¹Ÿåœ¨å¤„ç†ç™»å½•
    // å¯èƒ½å¯¼è‡´ï¼š
    // - è·¯ç”±ä¿¡æ¯è¢«è¦†ç›–
    // - å¤šç«¯ç™»å½•ä¿¡æ¯ä¸¢å¤±
    // - çŠ¶æ€ä¸ä¸€è‡´
}

void Gateway2_HandleLogin(int userId) {
    // è¦†ç›–äº†ç½‘å…³1çš„è®¾ç½®ï¼
    redis.set("user:gateway:" + userId, "gateway2");
    // ç”¨æˆ·åœ¨gateway1çš„è·¯ç”±ä¿¡æ¯ä¸¢å¤±
}

// âœ… ç‹¬ç«‹è·¯ç”±æœåŠ¡çš„æ–¹æ¡ˆ
class PresenceService {
    // ä½¿ç”¨åˆ†å¸ƒå¼é”ä¿è¯åŸå­æ€§
    void updateUserRoute(int userId, string gateway) {
        unique_lock lock("user_route_lock:" + userId);
        
        // 1. è¯»å–ç°æœ‰è·¯ç”±
        auto routes = getExistingRoutes(userId);
        
        // 2. å¤„ç†å¤šç«¯ç™»å½•ç­–ç•¥
        if (routes.size() >= MAX_DEVICES) {
            kickOldestDevice(routes);  // è¸¢æ‰æœ€æ—§çš„è®¾å¤‡
        }
        
        // 3. åŸå­æ›´æ–°
        routes.add(gateway);
        saveRoutes(userId, routes);
        
        // 4. é€šçŸ¥å…¶ä»–ç«¯ï¼ˆå¯é€‰ï¼‰
        notifyOtherDevices(userId, gateway);
    }
};
```

#### ä¸€è‡´æ€§ä¿éšœæœºåˆ¶å¯¹æ¯”ï¼š

| ä¸€è‡´æ€§éœ€æ±‚ | Redisç›´æ¥æ“ä½œ | ç‹¬ç«‹è·¯ç”±æœåŠ¡ |
|-----------|-------------|------------|
| **åŸå­æ€§æ“ä½œ** | Luaè„šæœ¬ï¼Œå¤æ‚ | æœåŠ¡å†…åŸå­æ€§ âœ… |
| **åˆ†å¸ƒå¼é”** | æ¯ä¸ªæœåŠ¡è‡ªå·±å®ç° | ç»Ÿä¸€ç®¡ç† âœ… |
| **äº‹åŠ¡æ”¯æŒ** | æœ‰é™çš„MULTI/EXEC | å®Œæ•´äº‹åŠ¡æ§åˆ¶ âœ… |
| **å†²çªæ£€æµ‹** | éœ€è¦æ‰‹åŠ¨ç¼–ç  | è‡ªåŠ¨æ£€æµ‹ âœ… |
| **å›æ»šæœºåˆ¶** | éš¾ä»¥å®ç° | æ”¯æŒå›æ»š âœ… |

---

### 3. **æ•…éšœå¤„ç†ä¸æ¢å¤** â­â­â­â­â­

#### æ•…éšœåœºæ™¯å¤„ç†ï¼š

```cpp
// åœºæ™¯ï¼šç½‘å…³çªç„¶å®•æœº

// âŒ Redisæ–¹æ¡ˆéœ€è¦æ¯ä¸ªæœåŠ¡è‡ªå·±å¤„ç†
class MessageService {
    void sendMessage(int userId, Message msg) {
        string gateway = redis.get("user:gateway:" + userId);
        
        try {
            sendToGateway(gateway, msg);
        } catch (NetworkException& e) {
            // æ¯ä¸ªæœåŠ¡éƒ½è¦å¤„ç†ï¼š
            // 1. æ£€æµ‹ç½‘å…³æ˜¯å¦çœŸçš„æŒ‚äº†
            // 2. æ¸…ç†Redisä¸­çš„è·¯ç”±ä¿¡æ¯
            // 3. æ ‡è®°ç”¨æˆ·ä¸ºç¦»çº¿
            // 4. å­˜å‚¨ç¦»çº¿æ¶ˆæ¯
            // 5. å¯èƒ½éœ€è¦é‡è¯•
            // é‡å¤ä»£ç ï¼Œéš¾ä»¥ç»´æŠ¤ï¼
        }
    }
};

// âœ… ç‹¬ç«‹è·¯ç”±æœåŠ¡ç»Ÿä¸€å¤„ç†
class PresenceService {
    // å¿ƒè·³æ£€æµ‹çº¿ç¨‹
    void heartbeatMonitor() {
        while (running) {
            for (auto& gateway : all_gateways) {
                if (!checkGatewayHealth(gateway)) {
                    handleGatewayFailure(gateway);
                }
            }
            sleep(5);
        }
    }
    
    void handleGatewayFailure(string gateway) {
        // 1. è·å–è¯¥ç½‘å…³ä¸Šçš„æ‰€æœ‰ç”¨æˆ·
        auto users = getUsersOnGateway(gateway);
        
        // 2. æ‰¹é‡æ ‡è®°ç”¨æˆ·ç¦»çº¿
        for (auto userId : users) {
            setUserOffline(userId, gateway);
        }
        
        // 3. æ¸…ç†è·¯ç”±ä¿¡æ¯
        cleanupGatewayRoutes(gateway);
        
        // 4. é€šçŸ¥ç›¸å…³æœåŠ¡
        notifyGatewayFailure(gateway);
        
        // 5. è§¦å‘å‘Šè­¦
        alertOps("Gateway failure: " + gateway);
    }
};
```

#### æ•…éšœå¤„ç†èƒ½åŠ›å¯¹æ¯”ï¼š

| æ•…éšœå¤„ç† | Redisæ–¹æ¡ˆ | ç‹¬ç«‹è·¯ç”±æœåŠ¡ |
|---------|----------|------------|
| **æ•…éšœæ£€æµ‹** | å„æœåŠ¡ç‹¬ç«‹æ£€æµ‹ | ç»Ÿä¸€å¿ƒè·³ç›‘æ§ âœ… |
| **è‡ªåŠ¨æ¸…ç†** | éœ€æ‰‹åŠ¨è§¦å‘ | è‡ªåŠ¨åŒ–æ¸…ç† âœ… |
| **æ•…éšœè½¬ç§»** | å¤æ‚å®ç° | è‡ªåŠ¨è½¬ç§» âœ… |
| **æ‰¹é‡å¤„ç†** | æ•ˆç‡ä½ | æ‰¹é‡é«˜æ•ˆ âœ… |
| **å‘Šè­¦é€šçŸ¥** | åˆ†æ•£å‘Šè­¦ | é›†ä¸­å‘Šè­¦ âœ… |
| **æ¢å¤æœºåˆ¶** | éš¾ä»¥åè°ƒ | ç»Ÿä¸€æ¢å¤ âœ… |

---

### 4. **æ€§èƒ½ä¼˜åŒ–ç©ºé—´** â­â­â­â­

#### æ€§èƒ½ä¼˜åŒ–å¯¹æ¯”ï¼š

```cpp
// âŒ Redisæ–¹æ¡ˆçš„æ€§èƒ½é—®é¢˜
void queryUserRoute(int userId) {
    // 1. éœ€è¦å¤šæ¬¡RedisæŸ¥è¯¢
    string status = redis.get("user:status:" + userId);      // 1æ¬¡ç½‘ç»œIO
    string gateway = redis.get("user:gateway:" + userId);    // 1æ¬¡ç½‘ç»œIO
    auto devices = redis.smembers("user:devices:" + userId); // 1æ¬¡ç½‘ç»œIO
    string lastSeen = redis.get("user:lastseen:" + userId);  // 1æ¬¡ç½‘ç»œIO
    
    // æ¯æ¬¡æŸ¥è¯¢4æ¬¡ç½‘ç»œIOï¼Œé«˜å¹¶å‘ä¸‹æˆä¸ºç“¶é¢ˆ
}

// âœ… ç‹¬ç«‹è·¯ç”±æœåŠ¡çš„ä¼˜åŒ–
class PresenceService {
private:
    // æœ¬åœ°ç¼“å­˜ï¼ˆLRUï¼‰
    LRUCache<int, UserRoute> local_cache_;
    
    // æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
    map<int, UserRoute> batchQueryRoutes(vector<int> userIds) {
        // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        map<int, UserRoute> result;
        vector<int> cache_miss;
        
        for (auto userId : userIds) {
            if (auto route = local_cache_.get(userId)) {
                result[userId] = route.value();
            } else {
                cache_miss.push_back(userId);
            }
        }
        
        // 2. æ‰¹é‡æŸ¥è¯¢Redisï¼ˆPipelineï¼‰
        if (!cache_miss.empty()) {
            auto redis_result = redis.pipeline()
                .mget(buildKeys(cache_miss))
                .execute();
            
            for (auto& [userId, route] : redis_result) {
                local_cache_.put(userId, route);
                result[userId] = route;
            }
        }
        
        return result;
    }
    
    // å†™å…¥ä¼˜åŒ–ï¼ˆæ‰¹é‡ + å¼‚æ­¥ï¼‰
    void asyncUpdateRoute(int userId, UserRoute route) {
        // 1. ç«‹å³æ›´æ–°æœ¬åœ°ç¼“å­˜
        local_cache_.put(userId, route);
        
        // 2. å¼‚æ­¥æ‰¹é‡å†™å…¥Redis
        batch_writer_.addUpdate(userId, route);
    }
};
```

#### æ€§èƒ½ä¼˜åŒ–èƒ½åŠ›ï¼š

| ä¼˜åŒ–é¡¹ | Redisç›´è¿ | ç‹¬ç«‹è·¯ç”±æœåŠ¡ |
|-------|----------|------------|
| **æœ¬åœ°ç¼“å­˜** | å„æœåŠ¡è‡ªå·±å®ç° | ç»Ÿä¸€ç¼“å­˜å±‚ âœ… |
| **æ‰¹é‡æŸ¥è¯¢** | éš¾ä»¥åè°ƒ | Pipelineä¼˜åŒ– âœ… |
| **å¼‚æ­¥å†™å…¥** | å¤æ‚å®ç° | æ‰¹é‡å¼‚æ­¥ âœ… |
| **è¿æ¥æ± ** | å„è‡ªç»´æŠ¤ | ç»Ÿä¸€è¿æ¥æ±  âœ… |
| **é¢„çƒ­æœºåˆ¶** | éš¾ä»¥å®ç° | å¯åŠ¨é¢„çƒ­ âœ… |
| **çƒ­ç‚¹æ•°æ®** | æ— æ³•è¯†åˆ« | æ™ºèƒ½ç¼“å­˜ âœ… |

#### æ€§èƒ½æå‡æ•°æ®ï¼š

```
ç›´æ¥Redisæ–¹æ¡ˆï¼š
- æ¯æ¬¡æŸ¥è¯¢å»¶è¿Ÿ: ~2-5ms (å¤šæ¬¡ç½‘ç»œIO)
- QPSä¸Šé™: ~5000 (Redisç“¶é¢ˆ)
- ç¼“å­˜å‘½ä¸­ç‡: 0% (æ— ç¼“å­˜)

ç‹¬ç«‹è·¯ç”±æœåŠ¡ï¼š
- æœ¬åœ°ç¼“å­˜å‘½ä¸­: ~0.01ms (å†…å­˜è®¿é—®)
- RedisæŸ¥è¯¢: ~1ms (Pipelineä¼˜åŒ–)
- QPSä¸Šé™: ~50000+ (æœ¬åœ°ç¼“å­˜)
- ç¼“å­˜å‘½ä¸­ç‡: 90%+ (çƒ­ç‚¹æ•°æ®)

æ€§èƒ½æå‡: 10å€+
```

---

### 5. **ä¸šåŠ¡æ‰©å±•æ€§** â­â­â­â­

#### æœªæ¥å¯èƒ½çš„æ‰©å±•éœ€æ±‚ï¼š

```cpp
// âœ… ç‹¬ç«‹æœåŠ¡æ˜“äºæ‰©å±•
class PresenceService {
    // æ‰©å±•1: ç”¨æˆ·çŠ¶æ€æœº
    enum UserStatus {
        ONLINE,      // åœ¨çº¿
        AWAY,        // ç¦»å¼€
        BUSY,        // å¿™ç¢Œ
        INVISIBLE,   // éšèº«
        OFFLINE      // ç¦»çº¿
    };
    
    void setUserStatus(int userId, UserStatus status) {
        // çŠ¶æ€è½¬æ¢è§„åˆ™
        // é€šçŸ¥è®¢é˜…è€…
        // è®°å½•çŠ¶æ€å†å²
    }
    
    // æ‰©å±•2: åœ°ç†ä½ç½®è·¯ç”±
    struct GeoRoute {
        string region;      // åœ°ç†åŒºåŸŸ
        string gateway;     // æœ€è¿‘ç½‘å…³
        int latency;        // å»¶è¿Ÿ
    };
    
    string selectBestGateway(int userId, string userRegion) {
        // åŸºäºåœ°ç†ä½ç½®é€‰æ‹©æœ€ä¼˜ç½‘å…³
        // è´Ÿè½½å‡è¡¡
        // å°±è¿‘è·¯ç”±
    }
    
    // æ‰©å±•3: åœ¨çº¿æ—¶é•¿ç»Ÿè®¡
    void trackOnlineTime(int userId) {
        // å®æ—¶ç»Ÿè®¡
        // è¡Œä¸ºåˆ†æ
        // æ´»è·ƒåº¦è¯„åˆ†
    }
    
    // æ‰©å±•4: çŠ¶æ€è®¢é˜…
    void subscribeUserStatus(int observerId, int targetUserId) {
        // å¥½å‹ä¸Šçº¿é€šçŸ¥
        // çŠ¶æ€å˜æ›´æ¨é€
        // åœ¨çº¿æé†’
    }
    
    // æ‰©å±•5: è´Ÿè½½å‡è¡¡
    string allocateGateway(int userId) {
        // åŠ¨æ€é€‰æ‹©è´Ÿè½½æœ€ä½çš„ç½‘å…³
        // è€ƒè™‘ç½‘ç»œå»¶è¿Ÿ
        // è€ƒè™‘åœ°ç†ä½ç½®
    }
};
```

#### æ‰©å±•èƒ½åŠ›å¯¹æ¯”ï¼š

| æ‰©å±•éœ€æ±‚ | Redisæ–¹æ¡ˆ | ç‹¬ç«‹è·¯ç”±æœåŠ¡ |
|---------|----------|------------|
| **çŠ¶æ€æœºç®¡ç†** | å¤æ‚çš„Luaè„šæœ¬ | é¢å‘å¯¹è±¡ âœ… |
| **åœ°ç†è·¯ç”±** | éš¾ä»¥å®ç° | çµæ´»æ‰©å±• âœ… |
| **ç»Ÿè®¡åˆ†æ** | éœ€è¦é¢å¤–æœåŠ¡ | å†…ç½®æ”¯æŒ âœ… |
| **äº‹ä»¶é€šçŸ¥** | éœ€è¦é¢å¤–ç»„ä»¶ | é›†æˆå‘å¸ƒè®¢é˜… âœ… |
| **åŠ¨æ€è´Ÿè½½å‡è¡¡** | å¤æ‚é€»è¾‘ | ç®—æ³•å¯æ’æ‹” âœ… |
| **A/Bæµ‹è¯•** | ä¸æ”¯æŒ | çµæ´»é…ç½® âœ… |

---

### 6. **ç›‘æ§ä¸è¿ç»´** â­â­â­â­

```cpp
// âœ… ç‹¬ç«‹æœåŠ¡ä¾¿äºç›‘æ§
class PresenceService {
    // ç›‘æ§æŒ‡æ ‡
    struct Metrics {
        atomic<uint64_t> total_users_online;
        atomic<uint64_t> total_route_queries;
        atomic<uint64_t> cache_hit_count;
        atomic<uint64_t> cache_miss_count;
        atomic<uint64_t> route_update_count;
        
        map<string, int> users_per_gateway;
        map<int, int> status_distribution;
        
        double avg_query_latency;
        double p99_query_latency;
    };
    
    // å¥åº·æ£€æŸ¥æ¥å£
    bool healthCheck() {
        return redis_healthy && mysql_healthy && 
               total_users_online < MAX_CAPACITY;
    }
    
    // è¿ç»´æ¥å£
    void forceOfflineUser(int userId) {
        // å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿ï¼ˆç”¨äºè¿ç»´ï¼‰
    }
    
    void kickDevice(int userId, string deviceId) {
        // è¸¢æ‰ç‰¹å®šè®¾å¤‡
    }
    
    void migrateUserToGateway(int userId, string targetGateway) {
        // è¿ç§»ç”¨æˆ·åˆ°æŒ‡å®šç½‘å…³ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
    }
};
```

#### ç›‘æ§è¿ç»´èƒ½åŠ›ï¼š

| èƒ½åŠ› | Redisæ–¹æ¡ˆ | ç‹¬ç«‹è·¯ç”±æœåŠ¡ |
|-----|----------|------------|
| **ç»Ÿä¸€ç›‘æ§** | éœ€è¦ä»å¤šå¤„é‡‡é›† | é›†ä¸­ç›‘æ§é¢æ¿ âœ… |
| **æ€§èƒ½æŒ‡æ ‡** | éš¾ä»¥ç»Ÿè®¡ | è¯¦ç»†æŒ‡æ ‡ âœ… |
| **å¥åº·æ£€æŸ¥** | åˆ†æ•£æ£€æŸ¥ | ç»Ÿä¸€å¥åº·æ£€æŸ¥ âœ… |
| **é—®é¢˜å®šä½** | æ—¥å¿—åˆ†æ•£ | é›†ä¸­æ—¥å¿— âœ… |
| **è¿ç»´æ¥å£** | éš¾ä»¥æä¾› | RESTful API âœ… |
| **ç°åº¦å‘å¸ƒ** | ä¸æ”¯æŒ | æ”¯æŒç°åº¦ âœ… |

---

## ğŸ“Š ç»¼åˆå¯¹æ¯”æ€»ç»“

### æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | Redisç›´è¿æ–¹æ¡ˆ | ç‹¬ç«‹è·¯ç”±æœåŠ¡ | ä¼˜åŠ¿æ–¹ |
|-----|-------------|------------|--------|
| **å®ç°å¤æ‚åº¦** | ç®€å•ï¼ˆåˆæœŸï¼‰ | ä¸­ç­‰ | Redis |
| **ç»´æŠ¤æˆæœ¬** | é«˜ï¼ˆé€»è¾‘åˆ†æ•£ï¼‰ | ä½ï¼ˆé›†ä¸­ç®¡ç†ï¼‰ | **è·¯ç”±æœåŠ¡** |
| **æ€§èƒ½** | ä¸­ç­‰ | é«˜ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰ | **è·¯ç”±æœåŠ¡** |
| **å¯é æ€§** | ä½ï¼ˆæ•…éšœå¤„ç†å¤æ‚ï¼‰ | é«˜ï¼ˆç»Ÿä¸€æ¢å¤ï¼‰ | **è·¯ç”±æœåŠ¡** |
| **æ‰©å±•æ€§** | å·®ï¼ˆLuaé™åˆ¶ï¼‰ | å¥½ï¼ˆC++çµæ´»ï¼‰ | **è·¯ç”±æœåŠ¡** |
| **ä¸€è‡´æ€§** | å¼±ï¼ˆéš¾ä¿è¯ï¼‰ | å¼ºï¼ˆäº‹åŠ¡æ”¯æŒï¼‰ | **è·¯ç”±æœåŠ¡** |
| **ç›‘æ§è¿ç»´** | å›°éš¾ | ä¾¿æ· | **è·¯ç”±æœåŠ¡** |
| **å›¢é˜Ÿåä½œ** | å›°éš¾ï¼ˆå„è‡ªå®ç°ï¼‰ | ç®€å•ï¼ˆç»Ÿä¸€æ¥å£ï¼‰ | **è·¯ç”±æœåŠ¡** |

### æˆæœ¬åˆ†æ

```
åˆæœŸå¼€å‘æˆæœ¬ï¼š
  Redisæ–¹æ¡ˆ:     1å‘¨ï¼ˆç®€å•å®ç°ï¼‰
  è·¯ç”±æœåŠ¡:      2-3å‘¨ï¼ˆå®Œæ•´å®ç°ï¼‰
  
é•¿æœŸç»´æŠ¤æˆæœ¬ï¼ˆå¹´ï¼‰ï¼š
  Redisæ–¹æ¡ˆ:     6äººæœˆï¼ˆåˆ†æ•£ç»´æŠ¤ï¼‰
  è·¯ç”±æœåŠ¡:      2äººæœˆï¼ˆé›†ä¸­ç»´æŠ¤ï¼‰
  
æ€§èƒ½ä¼˜åŒ–æˆæœ¬ï¼š
  Redisæ–¹æ¡ˆ:     éš¾ä»¥ä¼˜åŒ–ï¼ˆå—Redisé™åˆ¶ï¼‰
  è·¯ç”±æœåŠ¡:      çµæ´»ä¼˜åŒ–ï¼ˆå¤šç§æ‰‹æ®µï¼‰
  
æ•…éšœå¤„ç†æˆæœ¬ï¼š
  Redisæ–¹æ¡ˆ:     é«˜ï¼ˆå„æœåŠ¡ç‹¬ç«‹å¤„ç†ï¼‰
  è·¯ç”±æœåŠ¡:      ä½ï¼ˆç»Ÿä¸€å¤„ç†ï¼‰
```

---

## ğŸ¯ ä»€ä¹ˆæ—¶å€™å¯ä»¥ç”¨Redisï¼Ÿ

### Redisé€‚ç”¨åœºæ™¯ï¼š

1. **ç®€å•çš„KVå­˜å‚¨**
   - åªéœ€è¦ç®€å•çš„get/set
   - æ— å¤æ‚ä¸šåŠ¡é€»è¾‘
   - æ•°æ®é‡ä¸å¤§

2. **ç¼“å­˜å±‚**
   - ä½œä¸ºè·¯ç”±æœåŠ¡çš„ç¼“å­˜
   - åŠ é€Ÿçƒ­ç‚¹æ•°æ®è®¿é—®
   - é™ä½æ•°æ®åº“å‹åŠ›

3. **ç®€å•è®¡æ•°å™¨**
   - åœ¨çº¿äººæ•°ç»Ÿè®¡
   - æ¶ˆæ¯è®¡æ•°
   - é™æµè®¡æ•°

### Redisä¸é€‚åˆçš„åœºæ™¯ï¼ˆéœ€è¦ç‹¬ç«‹æœåŠ¡ï¼‰ï¼š

1. **å¤æ‚ä¸šåŠ¡é€»è¾‘**
   - å¤šæ­¥éª¤äº‹åŠ¡
   - å¤æ‚çš„çŠ¶æ€æœº
   - éœ€è¦å›è°ƒå’Œé€šçŸ¥

2. **å¼ºä¸€è‡´æ€§è¦æ±‚**
   - åˆ†å¸ƒå¼äº‹åŠ¡
   - æ•°æ®ä¸€è‡´æ€§ä¿è¯
   - å†²çªæ£€æµ‹å’Œè§£å†³

3. **çµæ´»æ‰©å±•éœ€æ±‚**
   - é¢‘ç¹çš„åŠŸèƒ½è¿­ä»£
   - å¤æ‚çš„ç®—æ³•é€»è¾‘
   - A/Bæµ‹è¯•éœ€æ±‚

---

## ğŸ—ï¸ æœ€ä½³å®è·µï¼šæ··åˆæ¶æ„

### æ¨èçš„æ¶æ„è®¾è®¡ï¼š

```mermaid
graph TB
    subgraph "æ··åˆæ¶æ„ - æœ€ä½³å®è·µ"
        Gateway[ç½‘å…³] --> PresenceService[è·¯ç”±æœåŠ¡<br/>ä¸šåŠ¡é€»è¾‘å±‚]
        
        PresenceService --> LocalCache[æœ¬åœ°LRUç¼“å­˜<br/>çƒ­ç‚¹æ•°æ®]
        PresenceService --> Redis[Redisç¼“å­˜<br/>åˆ†å¸ƒå¼ç¼“å­˜]
        PresenceService --> MySQL[(MySQL<br/>æŒä¹…åŒ–å­˜å‚¨)]
        
        LocalCache -.ç¼“å­˜æœªå‘½ä¸­.-> Redis
        Redis -.ç¼“å­˜æœªå‘½ä¸­.-> MySQL
    end
    
    style PresenceService fill:#9f9,stroke:#333,stroke-width:4px
    style LocalCache fill:#99f,stroke:#333,stroke-width:2px
    style Redis fill:#f99,stroke:#333,stroke-width:2px
```

### åˆ†å±‚èŒè´£ï¼š

```cpp
// 1. è·¯ç”±æœåŠ¡ - ä¸šåŠ¡é€»è¾‘å±‚
class PresenceService {
    RouteInfo getRoute(int userId) {
        // å¤æ‚ä¸šåŠ¡é€»è¾‘
        // ä¸€è‡´æ€§ä¿è¯
        // æ•…éšœå¤„ç†
    }
};

// 2. Redis - åˆ†å¸ƒå¼ç¼“å­˜å±‚
// - è·¨æœåŠ¡å…±äº«çš„è·¯ç”±ä¿¡æ¯
// - æŒä¹…åŒ–çš„ä¼šè¯æ•°æ®
// - åˆ†å¸ƒå¼é”

// 3. æœ¬åœ°ç¼“å­˜ - æ€§èƒ½ä¼˜åŒ–å±‚
// - æœ€çƒ­ç‚¹çš„è·¯ç”±æ•°æ®
// - å‡å°‘Redisè®¿é—®
// - æå‡å“åº”é€Ÿåº¦
```

---

## ğŸ’¡ ç»“è®º

### ä¸ºä»€ä¹ˆè¦ç‹¬ç«‹è·¯ç”±æœåŠ¡ï¼Ÿ

1. **å°è£…å¤æ‚çš„ä¸šåŠ¡é€»è¾‘** - ä¸æ˜¯ç®€å•çš„KVå­˜å‚¨
2. **ä¿è¯æ•°æ®ä¸€è‡´æ€§** - éœ€è¦äº‹åŠ¡å’Œé”
3. **ç»Ÿä¸€æ•…éšœå¤„ç†** - é¿å…é€»è¾‘åˆ†æ•£
4. **æ€§èƒ½ä¼˜åŒ–ç©ºé—´å¤§** - å¤šçº§ç¼“å­˜ã€æ‰¹é‡æ“ä½œ
5. **æ˜“äºæ‰©å±•** - C++æ¯”Luaçµæ´»å¾—å¤š
6. **ä¾¿äºç›‘æ§è¿ç»´** - é›†ä¸­ç®¡ç†å’Œç›‘æ§

### Redisçš„è§’è‰²

Redisä¸æ˜¯è¢«"æ›¿ä»£"äº†ï¼Œè€Œæ˜¯ï¼š
- ä½œä¸ºè·¯ç”±æœåŠ¡çš„**ç¼“å­˜å±‚**
- ä½œä¸º**åˆ†å¸ƒå¼ç¼“å­˜**å…±äº«æ•°æ®
- ä½œä¸º**æ¶ˆæ¯é˜Ÿåˆ—**ä¼ é€’äº‹ä»¶
- ä½œä¸º**åˆ†å¸ƒå¼é”**åè°ƒæ“ä½œ

### æœ€ç»ˆå»ºè®®

```
âœ… ä½¿ç”¨ç‹¬ç«‹è·¯ç”±æœåŠ¡å¤„ç†ï¼š
   - å¤æ‚ä¸šåŠ¡é€»è¾‘
   - çŠ¶æ€ç®¡ç†
   - æ•…éšœæ¢å¤
   - æ€§èƒ½ä¼˜åŒ–

âœ… ä½¿ç”¨Redisè¾…åŠ©ï¼š
   - åˆ†å¸ƒå¼ç¼“å­˜
   - è·¨æœåŠ¡å…±äº«
   - æ¶ˆæ¯ä¼ é€’
   - åˆ†å¸ƒå¼é”
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **å¾®æœåŠ¡è®¾è®¡åŸåˆ™** - Sam Newman
2. **Redisè®¾è®¡ä¸å®ç°** - é»„å¥å®
3. **åˆ†å¸ƒå¼ç³»ç»Ÿæ¨¡å¼** - Martin Fowler
4. **å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„** - ææ™ºæ…§

---

**æ€»ç»“**: ç‹¬ç«‹çš„è·¯ç”±æœåŠ¡ä¸æ˜¯ä¸ºäº†æ›¿ä»£Redisï¼Œè€Œæ˜¯ä¸ºäº†æ›´å¥½åœ°**å°è£…ä¸šåŠ¡é€»è¾‘**ã€**ä¿è¯ä¸€è‡´æ€§**ã€**ç»Ÿä¸€æ•…éšœå¤„ç†**å’Œ**ä¼˜åŒ–æ€§èƒ½**ã€‚Redisä½œä¸ºåº•å±‚çš„ç¼“å­˜å’Œå­˜å‚¨å·¥å…·ï¼Œä¸è·¯ç”±æœåŠ¡é…åˆä½¿ç”¨ï¼Œæ‰èƒ½æ„å»ºå‡ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚

