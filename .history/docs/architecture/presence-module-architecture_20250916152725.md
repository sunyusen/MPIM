# Presence模块架构设计

## 模块概述

Presence模块是即时通讯系统中的**路由管理服务**，负责管理用户在线状态和消息路由。它不存储用户数据，而是管理用户的**连接状态**和**路由信息**。

## 核心功能

### 1. 路由管理
- **BindRoute**: 绑定用户ID到网关ID的映射关系
- **QueryRoute**: 查询用户当前连接的网关ID
- **Deliver**: 将消息投递到用户所在的网关

### 2. 状态管理
- 维护用户在线状态
- 管理用户与网关的映射关系
- 处理用户上下线事件

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Presence Service                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   BindRoute     │    │   QueryRoute    │    │   Deliver    │ │
│  │                 │    │                 │    │              │ │
│  │ 用户ID → 网关ID  │    │ 查询用户路由    │    │ 消息投递     │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │  CacheManager   │    │  MessageQueue   │    │  GwChannelOf │ │
│  │                 │    │                 │    │              │ │
│  │ 路由信息存储     │    │ 消息队列        │    │ 网关通道映射 │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                          Redis 存储                            │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │   路由缓存       │    │   消息队列       │                    │
│  │                 │    │                 │                    │
│  │ route:user_id   │    │ PUBLISH/SUBSCRIBE│                   │
│  │ → gateway_id    │    │ 消息投递         │                    │
│  └─────────────────┘    └─────────────────┘                    │
└─────────────────────────────────────────────────────────────────┘
```

## 消息数据流程

### 1. 用户上线流程

```
Client                    Gateway                    Presence Service
  │                          │                              │
  │ ──── 连接请求 ──────────→ │                              │
  │                          │ ──── BindRoute ───────────→ │
  │                          │                              │
  │                          │                              │ ── 存储路由 ──→ Redis
  │                          │                              │
  │ ←──── 连接成功 ────────── │ ←──── 绑定成功 ──────────── │
  │                          │                              │
```

### 2. 消息投递流程

```
User A                    Gateway A                  Presence Service
  │                          │                              │
  │ ──── 发送消息 ──────────→ │                              │
  │                          │ ──── Deliver ─────────────→ │
  │                          │                              │
  │                          │                              │ ── 查询路由 ──→ Redis
  │                          │                              │
  │                          │                              │ ── 发布消息 ──→ Redis
  │                          │                              │
  │                          │                              │
User B                    Gateway B                  Message Queue
  │                          │                              │
  │ ←──── 接收消息 ────────── │ ←──── 订阅消息 ──────────── │
  │                          │                              │
```

### 3. 用户下线流程

```
Client                    Gateway                    Presence Service
  │                          │                              │
  │ ──── 断开连接 ──────────→ │                              │
  │                          │ ──── 清理路由 ────────────→ │
  │                          │                              │
  │                          │                              │ ── 删除路由 ──→ Redis
  │                          │                              │
```

## 数据存储结构

### Redis存储格式

```
路由信息存储:
- Key: "route:user_id"
- Value: "gateway_id"
- TTL: 120秒 (2分钟)

消息队列:
- Channel: 10000 + hash(gateway_id) % 50000
- Message: 序列化的消息内容
```

## 关键设计决策

### 1. 为什么使用Redis而不是数据库？

**原因**：
- **实时性要求高**: 路由查询需要毫秒级响应
- **数据临时性**: 用户下线后路由信息立即失效
- **高并发**: 支持大量用户同时在线
- **简单操作**: 只需要简单的键值存储

### 2. 为什么需要TTL？

**原因**：
- **防止僵尸连接**: 用户异常断线时自动清理
- **内存管理**: 避免Redis内存无限增长
- **数据一致性**: 确保路由信息的时效性

### 3. 为什么需要消息队列？

**原因**：
- **解耦**: Presence服务不需要知道具体网关实现
- **可靠性**: 消息投递失败时可以重试
- **扩展性**: 可以轻松添加新的网关节点

## 容错机制

### 1. Redis连接失败
- 服务继续运行，但消息投递功能受限
- 记录错误日志，定期重试连接
- 支持降级模式

### 2. 网关故障
- 路由信息自动过期
- 用户重新连接时重新绑定
- 消息投递失败时记录日志

### 3. 网络分区
- 使用TTL机制自动清理过期路由
- 支持服务重启后的状态恢复

## 性能特点

### 1. 高并发
- 支持数万用户同时在线
- 毫秒级路由查询响应
- 异步消息投递

### 2. 低延迟
- 内存存储，无磁盘I/O
- 简单的键值操作
- 网络延迟最小化

### 3. 高可用
- 无状态设计，支持水平扩展
- Redis集群支持
- 自动故障恢复

## 监控指标

### 1. 业务指标
- 在线用户数量
- 路由查询成功率
- 消息投递成功率
- 平均响应时间

### 2. 系统指标
- Redis连接状态
- 内存使用情况
- 网络延迟
- 错误率统计

## 总结

Presence模块是即时通讯系统的**核心路由服务**，它：

1. **不存储用户数据**，只管理连接状态
2. **使用Redis存储路由信息**，保证高性能
3. **通过消息队列投递消息**，实现解耦
4. **支持高并发和低延迟**，满足实时通讯需求
5. **具备完善的容错机制**，保证系统稳定性

这个设计既简单又高效，是典型的**状态管理服务**，而不是传统的数据缓存服务。
